<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Randomized Divination Query Builder</title>
    <style>
        :root {
            --bg-color: #1a1a2e;
            --container-bg: #16213e;
            --input-bg: #0f3460;
            --text-color: #e94560;
            --light-text: #dcdcdc;
            --border-color: #e94560;
            --button-bg: #e94560;
            --button-text: #ffffff;
            --button-hover-bg: #c73b52;
            --error-color: #ffcc00;
            --success-color: #4CAF50;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--light-text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 700px;
            background-color: var(--container-bg);
            padding: 25px 35px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
        }

        h1 {
            color: var(--text-color);
            text-align: center;
            margin-bottom: 10px;
        }

        .intro {
            text-align: center;
            margin-bottom: 25px;
            font-size: 0.95em;
            line-height: 1.5;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-color);
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 12px;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--light-text);
            font-size: 1em;
            box-sizing: border-box;
            transition: box-shadow 0.2s, background-color 0.2s;
        }
        
        textarea {
            resize: vertical;
            min-height: 60px;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.4);
        }
        
        textarea:read-only {
            background-color: #1f2a49;
            cursor: not-allowed;
        }

        .error-message {
            color: var(--error-color);
            font-size: 0.8em;
            margin-top: 5px;
            height: 1em;
        }

        .main-button {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            font-weight: bold;
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }

        .main-button:hover:not(:disabled) {
            background-color: var(--button-hover-bg);
        }
        
        .main-button:active:not(:disabled) {
            transform: translateY(1px);
        }

        .main-button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        .main-button.success {
            background-color: var(--success-color);
            cursor: default;
        }

        #number-entry-section,
        #results-section {
            display: none;
            margin-top: 30px;
            border-top: 2px solid var(--border-color);
            padding-top: 20px;
        }
        
        #results-section h2 {
            text-align: center;
            color: var(--text-color);
        }

        #results-summary {
            width: 100%;
            min-height: 300px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .copy-container {
            position: relative;
            margin-top: 15px;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Divination Query Builder</h1>
        <p class="intro">A two-step process: First, set your intention by entering your question. This shuffles the virtual decks. Then, choose your numbers to draw the results.</p>

        <!-- STEP 1: Question Entry -->
        <div id="question-section">
            <div class="form-group">
                <label for="question">Step 1: Enter Your Question</label>
                <textarea id="question" rows="3" placeholder="e.g., What should I focus on for the next month?"></textarea>
                <div class="error-message" id="question-error"></div>
            </div>
            <button id="submit-question-button" class="main-button">Prepare the Session</button>
        </div>

        <!-- STEP 2: Number Entry (Initially hidden) -->
        <div id="number-entry-section">
            <fieldset style="border-color: var(--border-color); border-radius: 6px;">
                <legend style="color: var(--text-color); padding: 0 10px;">Step 2: Choose Your Numbers</legend>

                <div class="form-group">
                    <label for="tarot-input">Tarot (1, 3, or 10 numbers from 1-156)</label>
                    <input type="text" id="tarot-input" placeholder="e.g., 7, 42, 111">
                    <div class="error-message" id="tarot-error"></div>
                </div>
                <div class="form-group">
                    <label for="iching-input">I-Ching (1 number from 1-64)</label>
                    <input type="text" id="iching-input" placeholder="e.g., 25">
                    <div class="error-message" id="iching-error"></div>
                </div>
                <div class="form-group">
                    <label for="iching-lines-input">I-Ching Moving Lines (1-6, comma-separated, or leave blank)</label>
                    <input type="text" id="iching-lines-input" placeholder="e.g., 2, 5">
                    <div class="error-message" id="iching-lines-error"></div>
                </div>
                <div class="form-group">
                    <label for="kabbalah-input">Kabbalah (Numbers from 1-32, comma-separated)</label>
                    <input type="text" id="kabbalah-input" placeholder="e.g., 1, 11, 21">
                    <div class="error-message" id="kabbalah-error"></div>
                </div>
                <div class="form-group">
                    <label for="runes-input">Runes (1 or 3 numbers from 1-25)</label>
                    <input type="text" id="runes-input" placeholder="e.g., 19">
                    <div class="error-message" id="runes-error"></div>
                </div>
            </fieldset>
            <button id="generate-results-button" class="main-button" style="margin-top: 15px;">Generate Divination Query</button>
        </div>

        <!-- STEP 3: Results (Initially hidden) -->
        <div id="results-section">
            <h2>Your Divination Results</h2>
            <p style="text-align:center;">Copy the text below and paste it into your AI assistant for interpretation.</p>
            <textarea id="results-summary" readonly></textarea>
            <div class="copy-container">
                <button id="copy-button" class="main-button">Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA CONSTANTS ---
        const TAROT_CARDS = [
            "0: The Fool", "1: The Magician", "2: The High Priestess", "3: The Empress", "4: The Emperor", "5: The Hierophant", "6: The Lovers", "7: The Chariot", "8: Strength", "9: The Hermit", "10: Wheel of Fortune", "11: Justice", "12: The Hanged Man", "13: Death", "14: Temperance", "15: The Devil", "16: The Tower", "17: The Star", "18: The Moon", "19: The Sun", "20: Judgement", "21: The World", "22: Ace of Wands", "23: Two of Wands", "24: Three of Wands", "25: Four of Wands", "26: Five of Wands", "27: Six of Wands", "28: Seven of Wands", "29: Eight of Wands", "30: Nine of Wands", "31: Ten of Wands", "32: Page of Wands", "33: Knight of Wands", "34: Queen of Wands", "35: King of Wands", "36: Ace of Cups", "37: Two of Cups", "38: Three of Cups", "39: Four of Cups", "40: Five of Cups", "41: Six of Cups", "42: Seven of Cups", "43: Eight of Cups", "44: Nine of Cups", "45: Ten of Cups", "46: Page of Cups", "47: Knight of Cups", "48: Queen of Cups", "49: King of Cups", "50: Ace of Swords", "51: Two of Swords", "52: Three of Swords", "53: Four of Swords", "54: Five of Swords", "55: Six of Swords", "56: Seven of Swords", "57: Eight of Swords", "58: Nine of Swords", "59: Ten of Swords", "60: Page of Swords", "61: Knight of Swords", "62: Queen of Swords", "63: King of Swords", "64: Ace of Pentacles", "65: Two of Pentacles", "66: Three of Pentacles", "67: Four of Pentacles", "68: Five of Pentacles", "69: Six of Pentacles", "70: Seven of Pentacles", "71: Eight of Pentacles", "72: Nine of Pentacles", "73: Ten of Pentacles", "74: Page of Pentacles", "75: Knight of Pentacles", "76: Queen of Pentacles", "77: King of Pentacles"
        ];
        const CELTIC_CROSS_POSITIONS = [ "The Heart of the Matter", "The Crossing Card (Challenge)", "The Foundation (Basis)", "The Recent Past", "The Crown (Potential Outcome)", "The Near Future", "Yourself / Your Attitude", "Your Environment / External Influences", "Hopes and Fears", "The Final Outcome" ];
        const ICHING_HEXAGRAMS = [
            "1: Ch'ien / The Creative","2: K'un / The Receptive","3: Chun / Difficulty at the Beginning","4: Meng / Youthful Folly",
            "5: Hsü / Waiting","6: Sung / Conflict","7: Shih / The Army","8: Pi / Holding Together",
            "9: Hsiao Ch'u / The Taming Power of the Small","10: Lü / Treading","11: T'ai / Peace","12: P'i / Standstill",
            "13: T'ung Jen / Fellowship with Men","14: Ta Yu / Possession in Great Measure","15: Ch'ien / Modesty",
            "16: Yü / Enthusiasm","17: Sui / Following","18: Ku / Work on What Has Been Spoiled","19: Lin / Approach",
            "20: Kuan / Contemplation","21: Shih Ho / Biting Through","22: Pi / Grace","23: Po / Splitting Apart",
            "24: Fu / Return","25: Wu Wang / Innocence","26: Ta Ch'u / The Taming Power of the Great","27: I / Corners of the Mouth",
            "28: Ta Kuo / Preponderance of the Great","29: K'an / The Abysmal","30: Li / The Clinging (Fire)",
            "31: Hsien / Influence (Wooing)","32: Heng / Duration","33: Tun / Retreat","34: Ta Chuang / The Power of the Great",
            "35: Chin / Progress","36: Ming I / Darkening of the Light","37: Chia Jen / The Family","38: K'uei / Opposition",
            "39: Chien / Obstruction","40: Hsieh / Deliverance","41: Sun / Decrease","42: I / Increase",
            "43: Kuai / Break-through","44: Kou / Coming to Meet","45: Ts'ui / Gathering Together","46: Sheng / Pushing Upward",
            "47: Kùn / Oppression (Exhaustion)","48: Ching / The Well","49: Ko / Revolution","50: Ting / The Cauldron",
            "51: Chen / The Arousing","52: Ken / Keeping Still","53: Chien / Gradual Progress (Development)","54: Kuei Mei / The Marrying Maiden",
            "55: Feng / Abundance","56: Lü / The Wanderer","57: Sun / The Gentle","58: Tui / The Joyous",
            "59: Huan / Dispersion","60: Chieh / Limitation","61: Chung Fu / Inner Truth","62: Hsiao Kuo / Preponderance of the Small",
            "63: Chi Chi / After Completion","64: Wei Chi / Before Completion"
        ];

        const KABBALAH_PATHS = [
            "1: Kether (Crown)","2: Chokmah (Wisdom)","3: Binah (Understanding)","4: Chesed (Mercy)",
            "5: Geburah (Strength)","6: Tiphareth (Beauty)","7: Netzach (Victory)","8: Hod (Splendor)",
            "9: Yesod (Foundation)","10: Malkuth (Kingdom)",
            "11: Path of Aleph (Fool)","12: Path of Beth (Magician)","13: Path of Gimel (High Priestess)",
            "14: Path of Daleth (Empress)","15: Path of Heh (Emperor)","16: Path of Vav (Hierophant)",
            "17: Path of Zayin (Lovers)","18: Path of Cheth (Chariot)","19: Path of Teth (Strength)","20: Path of Yod (Hermit)",
            "21: Path of Kaph (Wheel)","22: Path of Lamed (Justice)","23: Path of Mem (Hanged Man)","24: Path of Nun (Death)",
            "25: Path of Samekh (Temperance)","26: Path of Ayin (Devil)","27: Path of Peh (Tower)","28: Path of Tzaddi (Star)",
            "29: Path of Qoph (Moon)","30: Path of Resh (Sun)","31: Path of Shin (Judgement)","32: Path of Tau (World)"
        ];

        const ELDER_FUTHARK_RUNES = [
            "1: Fehu (Cattle, Wealth)","2: Uruz (Aurochs, Strength)","3: Thurisaz (Giant, Thorn)","4: Ansuz (A God, Mouth)",
            "5: Raidho (Ride, Journey)","6: Kenaz (Torch)","7: Gebo (Gift)","8: Wunjo (Joy)","9: Hagalaz (Hail)",
            "10: Nauthiz (Need)","11: Isa (Ice)","12: Jera (Year, Harvest)","13: Eihwaz (Yew Tree)","14: Perthro (Lot Cup, Mystery)",
            "15: Algiz (Elk, Protection)","16: Sowilo (Sun)","17: Tiwaz (The God Tyr)","18: Berkano (Birch)",
            "19: Ehwaz (Horse)","20: Mannaz (Mankind)","21: Laguz (Water, Lake)","22: Ingwaz (The God Ing)","23: Dagaz (Day)",
            "24: Othala (Heritage, Estate)","25: Blank Rune (modern/optional)"
        ];
        
        // --- GLOBAL STATE ---
        let mapper = null;
        let userQuestion = '';

        // --- DOM Elements ---
        const questionEl = document.getElementById('question');
        const submitQuestionBtn = document.getElementById('submit-question-button');
        const generateResultsBtn = document.getElementById('generate-results-button');
        const copyBtn = document.getElementById('copy-button');
        const numberEntrySection = document.getElementById('number-entry-section');
        const resultsSection = document.getElementById('results-section');
        const resultsSummaryEl = document.getElementById('results-summary');

        const inputs = {
            tarot: { el: document.getElementById('tarot-input'), errorEl: document.getElementById('tarot-error') },
            iching: { el: document.getElementById('iching-input'), errorEl: document.getElementById('iching-error') },
            ichingLines: { el: document.getElementById('iching-lines-input'), errorEl: document.getElementById('iching-lines-error') },
            kabbalah: { el: document.getElementById('kabbalah-input'), errorEl: document.getElementById('kabbalah-error') },
            runes: { el: document.getElementById('runes-input'), errorEl: document.getElementById('runes-error') },
            question: { el: questionEl, errorEl: document.getElementById('question-error') }
        };

        // --- CORE LOGIC: REPLICATING PYTHON'S DETERMINISTIC RANDOMNESS ---
        function seededRNG(seed) {
            return function() {
                let t = seed += 0x6D2B79F5;
                t = Math.imul(t ^ t >>> 15, t | 1);
                t ^= t + Math.imul(t ^ t >>> 7, t | 61);
                return ((t ^ t >>> 14) >>> 0) / 4294967296;
            }
        }
        function shuffle(array, rng) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(rng() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }
        async function sha256(buffer) { return await crypto.subtle.digest('SHA-256', buffer); }
        function arrayBufferToHex(buffer) {
            return [...new Uint8Array(buffer)].map(b => b.toString(16).padStart(2, '0')).join('');
        }
        async function createSeedHash(question) {
            const combinedSalt = (String(Date.now()) + question);
            const encoder = new TextEncoder();
            let currentHashBuffer = await sha256(encoder.encode(combinedSalt));
            for (let i = 0; i < 8888; i++) {
                currentHashBuffer = await sha256(currentHashBuffer);
            }
            return arrayBufferToHex(currentHashBuffer);
        }

        class DivinationMapper {
            constructor(seedHash) {
                const seed = Number(BigInt('0x' + seedHash.slice(0, 8)) & 0xFFFFFFFFn);
                this.rng = seededRNG(seed);
                const tarotMaster = [];
                TAROT_CARDS.forEach(c => {
                    tarotMaster.push(`${c} (Upright)`);
                    tarotMaster.push(`${c} (Reversed)`);
                });
                this.tarotMap = shuffle(tarotMaster, this.rng);
                const range = (start, end) => Array.from({length: end - start + 1}, (_, i) => start + i);
                this.ichingMap = shuffle(range(1, 64), this.rng);
                this.kabbalahMap = shuffle(range(1, 32), this.rng);
                this.runesMap = shuffle(range(1, 25), this.rng);
            }
            mapNumber(number, systemMap) { return systemMap[number - 1]; }
            mapList(numbers, systemMap) { return numbers.map(n => this.mapNumber(n, systemMap)); }
        }

        // --- INPUT VALIDATION ---
        function clearErrors() {
            Object.values(inputs).forEach(input => input.errorEl.textContent = '');
        }
        
        function parseAndValidateList(key, minVal, maxVal, allowedCounts = null, canBeEmpty = false) {
            const { el, errorEl } = inputs[key];
            const value = el.value.trim();
            if (value === '' && canBeEmpty) return [];
            if (value === '') {
                 errorEl.textContent = "This field cannot be empty.";
                 return null;
            }
            const parts = value.split(',').map(p => p.trim()).filter(p => p !== '');
            if (allowedCounts && !allowedCounts.includes(parts.length)) {
                errorEl.textContent = `Please provide exactly ${allowedCounts.join(' or ')} numbers.`;
                return null;
            }
            const numbers = [];
            const seen = new Set();
            for (const part of parts) {
                const num = parseInt(part, 10);
                if (isNaN(num)) {
                    errorEl.textContent = `'${part}' is not a valid number.`;
                    return null;
                }
                if (num < minVal || num > maxVal) {
                    errorEl.textContent = `Number ${num} is out of range (${minVal}-${maxVal}).`;
                    return null;
                }
                seen.add(num);
                numbers.push(num);
            }
            return numbers;
        }

        function validateNumberInputs() {
            let isValid = true;
            const data = {};
            data.user_tarot = parseAndValidateList('tarot', 1, 156, [1, 3, 10]);
            if (data.user_tarot === null) isValid = false;
            const ichingInput = parseAndValidateList('iching', 1, 64, [1]);
            data.user_iching = ichingInput ? ichingInput[0] : null;
            if (data.user_iching === null) isValid = false;
            data.iching_lines = parseAndValidateList('ichingLines', 1, 6, null, true);
            if (data.iching_lines === null) isValid = false;
            data.user_kabbalah = parseAndValidateList('kabbalah', 1, 32, null, true);
            if (data.user_kabbalah === null) isValid = false;
            data.user_runes = parseAndValidateList('runes', 1, 25, [1, 3]);
            if (data.user_runes === null) isValid = false;
            return isValid ? data : null;
        }

        // --- SUMMARY GENERATION ---
        function generateSummary(question, data) {
            let summary = `My Question: "${question}"

Please provide an interpretation based on the following divination results.

For this session, all possible outcomes for each system (e.g., all 156 Tarot card states, all 64 I-Ching hexagrams) were arranged in a unique, random order based on my question and the timestamp. The "position" number I provide indicates where in that random sequence the result was drawn from. A lower number means it was drawn from nearer the "top" of the randomized set.

--- Tarot ---
`;
            const { user_tarot, result_tarot } = data;
            if (result_tarot.length === 1) {
                summary += `Result: ${result_tarot[0]} (drawn from position ${user_tarot[0]})\n`;
            } else if (result_tarot.length === 3) {
                summary += "Spread: Past, Present, Future\n";
                const labels = ["1. Past", "2. Present", "3. Future"];
                labels.forEach((label, i) => {
                    summary += `${label}: ${result_tarot[i]} (drawn from position ${user_tarot[i]})\n`;
                });
            } else if (result_tarot.length === 10) {
                summary += "Spread: Celtic Cross\n";
                CELTIC_CROSS_POSITIONS.forEach((pos, i) => {
                    summary += `${i + 1}. ${pos}: ${result_tarot[i]} (drawn from position ${user_tarot[i]})\n`;
                });
            }

            const hexagramName = ICHING_HEXAGRAMS[data.result_iching - 1];
            summary += `
--- I-Ching ---
Hexagram: ${hexagramName} (drawn from position ${data.user_iching})
Moving Lines: ${data.iching_lines.length > 0 ? data.iching_lines.join(', ') : 'None'}
`;
            summary += `\n--- Kabbalah ---\n`;
            if (data.user_kabbalah.length > 0) {
                const pairs = data.user_kabbalah.map((original, i) => {
                    const mappedNum = data.result_kabbalah[i];
                    const mappedName = KABBALAH_PATHS[mappedNum - 1];
                    return `${mappedName} (from position ${original})`;
                });
                summary += `Paths: ${pairs.join(', ')}\n`;
            } else { summary += "Paths: None\n"; }
            
            summary += `\n--- Runes ---\n`;
            if (data.user_runes.length > 0) {
                const pairs = data.user_runes.map((original, i) => {
                    const mappedNum = data.result_runes[i];
                    const mappedName = ELDER_FUTHARK_RUNES[mappedNum - 1];
                    return `${mappedName} (from position ${original})`;
                });
                summary += `Runes: ${pairs.join(', ')}\n`;
            } else { summary += "Runes: None\n"; }
            return summary.trim();
        }

        // --- EVENT LISTENERS ---
        submitQuestionBtn.addEventListener('click', async () => {
            clearErrors();
            userQuestion = questionEl.value.trim();
            if (userQuestion === '') {
                inputs.question.errorEl.textContent = 'Please enter a question to seed the session.';
                return;
            }
            submitQuestionBtn.disabled = true;
            submitQuestionBtn.textContent = 'Preparing Session... Please Wait';
            questionEl.readOnly = true;
            try {
                const seedHash = await createSeedHash(userQuestion);
                mapper = new DivinationMapper(seedHash);
                submitQuestionBtn.textContent = 'Session Prepared!';
                submitQuestionBtn.classList.add('success');
                numberEntrySection.style.display = 'block';
            } catch(error) {
                console.error("Hashing error:", error);
                inputs.question.errorEl.textContent = 'Could not prepare session. Please try again.';
                submitQuestionBtn.disabled = false;
                submitQuestionBtn.textContent = 'Prepare the Session';
                questionEl.readOnly = false;
            }
        });

        generateResultsBtn.addEventListener('click', () => {
            clearErrors();
            const numberData = validateNumberInputs();
            if (!numberData) return;
            if (!mapper) {
                alert("Session is not prepared. Please enter a question and prepare the session first.");
                return;
            }
            const resultsData = {
                ...numberData,
                result_tarot: mapper.mapList(numberData.user_tarot, mapper.tarotMap),
                result_iching: mapper.mapNumber(numberData.user_iching, mapper.ichingMap),
                result_kabbalah: mapper.mapList(numberData.user_kabbalah, mapper.kabbalahMap),
                result_runes: mapper.mapList(numberData.user_runes, mapper.runesMap)
            };
            const summaryText = generateSummary(userQuestion, resultsData);
            resultsSummaryEl.value = summaryText;
            resultsSection.style.display = 'block';
            resultsSummaryEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        });

        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(resultsSummaryEl.value).then(() => {
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'Copied!';
                setTimeout(() => { copyBtn.textContent = originalText; }, 2000);
            }).catch(err => console.error('Failed to copy text: ', err));
        });
    </script>
</body>
</html>